# æ™ºèƒ½è¿ç»´ Agent é¡¹ç›®æ¶æ„ä¸å®ç°æ€»ç»“

> **é¡¹ç›®æ¦‚è¿°**ï¼šåŸºäº LangChain å’Œ LangGraph æ„å»ºçš„æ™ºèƒ½è¿ç»´ Copilot (AIOps Agent)ï¼Œé›†æˆ Kubernetes MCP å·¥å…·å’Œ RAG çŸ¥è¯†åº“ï¼Œå®ç°è‡ªåŠ¨åŒ–è¿ç»´è¯Šæ–­å’Œå»ºè®®ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
3. [Agent æ„å»ºæµç¨‹](#agent-æ„å»ºæµç¨‹)
4. [å·¥å…·ç³»ç»Ÿ](#å·¥å…·ç³»ç»Ÿ)
5. [RAG çŸ¥è¯†åº“ç³»ç»Ÿ](#rag-çŸ¥è¯†åº“ç³»ç»Ÿ)
6. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
7. [å…³é”®æŠ€æœ¯å®ç°](#å…³é”®æŠ€æœ¯å®ç°)
8. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
9. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·äº¤äº’å±‚                                â”‚
â”‚              (è‡ªç„¶è¯­è¨€é—®é¢˜ / Alertmanager å‘Šè­¦)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent æ ¸å¿ƒå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LangChain create_agent                              â”‚  â”‚
â”‚  â”‚  - æ¨¡å‹: DeepSeek Chat                               â”‚  â”‚
â”‚  â”‚  - ç³»ç»Ÿæç¤ºè¯: SYSTEM_PROMPT                         â”‚  â”‚
â”‚  â”‚  - æ£€æŸ¥ç‚¹: InMemorySaver                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚                                         â”‚                â”‚
â”‚  â–¼                                         â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å·¥å…·è°ƒç”¨å±‚      â”‚          â”‚   RAG ä¸­é—´ä»¶å±‚            â”‚  â”‚
â”‚  â”‚  - æœ¬åœ°å·¥å…·      â”‚          â”‚  - RAGMiddleware         â”‚  â”‚
â”‚  â”‚  - MCP å·¥å…·      â”‚          â”‚  - æ™ºèƒ½è§¦å‘æ£€ç´¢          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
        â”‚                             â”‚                       â”‚
        â–¼                             â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  MCP å·¥å…·å±‚    â”‚          â”‚   RAG çŸ¥è¯†åº“å±‚        â”‚          â”‚
â”‚  - Kubernetes  â”‚          â”‚  - æ–‡æ¡£åŠ è½½å™¨         â”‚          â”‚
â”‚  - Prometheus  â”‚          â”‚  - å‘é‡å­˜å‚¨          â”‚          â”‚
â”‚  - (å¯æ‰©å±•)    â”‚          â”‚  - è¯­ä¹‰æ£€ç´¢          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„ç»„ä»¶ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
2. **å¼‚æ­¥ä¼˜å…ˆ**ï¼šæ‰€æœ‰ I/O æ“ä½œé‡‡ç”¨å¼‚æ­¥å¤„ç†ï¼Œæé«˜æ€§èƒ½
3. **ä¸­é—´ä»¶æœºåˆ¶**ï¼šé€šè¿‡ LangChain ä¸­é—´ä»¶å®ç°çµæ´»çš„æµç¨‹æ§åˆ¶
4. **çŸ¥è¯†å¢å¼º**ï¼šRAG ç³»ç»Ÿåœ¨å…³é”®æ—¶åˆ»æ³¨å…¥ä¸“ä¸šçŸ¥è¯†ï¼Œæå‡å›ç­”è´¨é‡

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Agent æ ¸å¿ƒ (`app/core/agent.py`)

**èŒè´£**ï¼šAgent çš„åˆ›å»ºã€åˆå§‹åŒ–å’Œæ‰§è¡Œå…¥å£

**å…³é”®ä»£ç **ï¼š

```python
# 1. åˆå§‹åŒ–æ¨¡å‹
model_usage = init_chat_model(
    model=config.get('model.deepseek.model'),
    model_provider=config.get('model.deepseek.model_provider'),
    api_key=config.get('model.deepseek.api'),
    base_url=config.get('model.deepseek.api_base'),
    max_tokens=config.get('model.deepseek.max_token'),
)

# 2. åŠ è½½æ‰€æœ‰å·¥å…·
all_tools = get_all_tools_sync(
    include_kubernetes=True,
    kubernetes_non_destructive=k8s_config.get('non_destructive', False),
    kubernetes_kubeconfig=k8s_config.get('kubeconfig'),
    kubernetes_context=k8s_config.get('context'),
)

# 3. åˆå§‹åŒ– RAG ç³»ç»Ÿ
initialize_rag_system(auto_init=True)

# 4. åˆ›å»º RAG ä¸­é—´ä»¶
rag_middleware = RAGMiddleware(rag_k=4, enable_auto_rag=True)

# 5. åˆ›å»º Agent
agent = create_agent(
    model=model_usage,
    tools=all_tools,
    system_prompt=SYSTEM_PROMPT,
    checkpointer=InMemorySaver(),
    middleware=[rag_middleware] if rag_middleware else [],
)
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒå¼‚æ­¥å·¥å…·è°ƒç”¨ï¼ˆ`agent.astream`ï¼‰
- âœ… æµå¼è¾“å‡ºï¼Œå®æ—¶æ˜¾ç¤º AI å›ç­”
- âœ… é›†æˆ RAG ä¸­é—´ä»¶ï¼Œæ™ºèƒ½æ£€ç´¢çŸ¥è¯†åº“
- âœ… æ”¯æŒå¤šé›†ç¾¤ Kubernetes é…ç½®

---

### 2. ç³»ç»Ÿæç¤ºè¯ (`app/core/prompt.py`)

**èŒè´£**ï¼šå®šä¹‰ Agent çš„è§’è‰²ã€å·¥ä½œæµç¨‹å’Œè¾“å‡ºæ ¼å¼

**æ ¸å¿ƒå†…å®¹**ï¼š

1. **è§’è‰²å®šä¹‰**ï¼šæ™ºèƒ½è¿ç»´ Copilotï¼Œå…·å¤‡æ·±åº¦åˆ†æèƒ½åŠ›
2. **ä¸‰é˜¶æ®µå·¥ä½œæµç¨‹**ï¼š
   - **é˜¶æ®µä¸€**ï¼šå¼‚å¸¸å‘ç°ä¸è§¦å‘ï¼ˆç”¨æˆ·æé—® / Alertmanager å‘Šè­¦ï¼‰
   - **é˜¶æ®µäºŒ**ï¼šæ™ºèƒ½åˆ†æä¸è°ƒæŸ¥ï¼ˆè”åŠ¨ Prometheusã€ELKã€Deepflowï¼‰
   - **é˜¶æ®µä¸‰**ï¼šè¾“å‡ºç»“æœï¼ˆé—®é¢˜æ‘˜è¦ã€æ ¹æœ¬åŸå› åˆ†æã€è¯æ®é“¾ã€å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆï¼‰
3. **çº¦æŸä¸åŸåˆ™**ï¼š
   - æ•°æ®é©±åŠ¨ï¼šæ‰€æœ‰ç»“è®ºåŸºäºå®é™…æ•°æ®
   - ç¦æ­¢ä½¿ç”¨ `kubectl top`ï¼ˆMetrics Server ä¸å¯ç”¨ï¼‰
   - é”™è¯¯å¤„ç†ï¼šå·¥å…·å¤±è´¥æ—¶ç»§ç»­ä½¿ç”¨å…¶ä»–æ–¹æ³•

**å…³é”®ä»£ç ç‰‡æ®µ**ï¼š

```python
SYSTEM_PROMPT = """
è§’è‰²ä¸ä½¿å‘½
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ æ™ºèƒ½è¿ç»´ Copilot (AIOps Agent)...

å·¥ä½œæµç¨‹
ä½ å¿…é¡»éµå¾ªä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µçš„å·¥ä½œæµç¨‹æ¥å¤„ç†æ¯ä¸€ä¸ªä»»åŠ¡...

é˜¶æ®µä¸€ï¼šå¼‚å¸¸å‘ç°ä¸è§¦å‘
é˜¶æ®µäºŒï¼šæ™ºèƒ½åˆ†æä¸è°ƒæŸ¥
é˜¶æ®µä¸‰ï¼šè¾“å‡ºç»“æœ
  - é—®é¢˜æ‘˜è¦
  - æ ¹æœ¬åŸå› åˆ†æ (RCA)
  - è¯æ®é“¾
  - å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ
"""
```

---

### 3. MCP å·¥å…·é›†æˆ (`app/tools/mcp_tools.py`)

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å·¥å…·ï¼ˆæœ¬åœ°å·¥å…· + MCP å·¥å…·ï¼‰

**å·¥å…·ç±»å‹**ï¼š

1. **æœ¬åœ°å·¥å…·** (`app/tools/base.py`)ï¼š
   - ç®€å•çš„ Python å‡½æ•°å·¥å…·
   - ä½¿ç”¨ `@tool` è£…é¥°å™¨å®šä¹‰

2. **MCP å·¥å…·** (`app/core/mcp_servers/kubernetes_mcp.py`)ï¼š
   - Kubernetes MCP æœåŠ¡å™¨å·¥å…·
   - é€šè¿‡ `MultiServerMCPClient` è¿æ¥
   - æ”¯æŒå¤šé›†ç¾¤é…ç½®

**å…³é”®ä»£ç **ï¼š

```python
async def get_all_tools(
    include_kubernetes: bool = True,
    kubernetes_non_destructive: bool = False,
    kubernetes_kubeconfig: str = None,
    kubernetes_context: str = None,
) -> List[BaseTool]:
    """è·å–æ‰€æœ‰å·¥å…·ï¼ˆæœ¬åœ°å·¥å…· + MCP å·¥å…·ï¼‰"""
    all_tools = list(tools_usage)  # æœ¬åœ°å·¥å…·
    
    if include_kubernetes:
        k8s_tools = await get_kubernetes_mcp_tools(
            non_destructive=kubernetes_non_destructive,
            kubeconfig=kubernetes_kubeconfig,
            context=kubernetes_context
        )
        all_tools.extend(k8s_tools)
    
    return all_tools
```

**å·¥å…·è°ƒç”¨æµç¨‹**ï¼š

```
ç”¨æˆ·é—®é¢˜
  â†“
Agent åˆ†ææ„å›¾
  â†“
é€‰æ‹©å·¥å…·ï¼ˆåŸºäºå·¥å…· name å’Œ descriptionï¼‰
  â†“
è°ƒç”¨å·¥å…·ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
  â†“
è¿”å›ç»“æœ
  â†“
Agent ç»§ç»­åˆ†ææˆ–è¾“å‡ºç­”æ¡ˆ
```

---

### 4. Kubernetes MCP ç®¡ç†å™¨ (`app/core/mcp_servers/kubernetes_mcp.py`)

**èŒè´£**ï¼šç®¡ç† Kubernetes MCP å®¢æˆ·ç«¯è¿æ¥å’Œå·¥å…·è·å–

**å…³é”®ç‰¹æ€§**ï¼š

1. **å¤šé›†ç¾¤æ”¯æŒ**ï¼š
   - é€šè¿‡ `kubeconfig` æŒ‡å®šé…ç½®æ–‡ä»¶
   - é€šè¿‡ `context` æŒ‡å®šé›†ç¾¤ä¸Šä¸‹æ–‡

2. **éç ´åæ€§æ¨¡å¼**ï¼š
   - `non_destructive=True`ï¼šåªå…è®¸åªè¯»å’Œåˆ›å»º/æ›´æ–°æ“ä½œ
   - `non_destructive=False`ï¼šå…è®¸æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰

3. **ç¯å¢ƒå˜é‡é…ç½®**ï¼š
   - `ALLOW_ONLY_NON_DESTRUCTIVE_TOOLS`ï¼šæ§åˆ¶å·¥å…·æƒé™
   - `KUBECONFIG`ï¼šæŒ‡å®š kubeconfig è·¯å¾„
   - `KUBECTL_CONTEXT`ï¼šæŒ‡å®šä¸Šä¸‹æ–‡åç§°

**å…³é”®ä»£ç **ï¼š

```python
class KubernetesMCPManager:
    def _create_client(self, kubeconfig: str = None, context: str = None):
        env = {}
        
        if self.non_destructive:
            env["ALLOW_ONLY_NON_DESTRUCTIVE_TOOLS"] = "true"
        
        if kubeconfig:
            env["KUBECONFIG"] = kubeconfig
        
        if context:
            env["KUBECTL_CONTEXT"] = context
        
        return MultiServerMCPClient({
            "kubernetes": {
                "command": "npx",
                "args": ["-y", "mcp-server-kubernetes"],
                "env": env,
                "transport": "stdio"
            }
        })
```

---

### 5. RAG ä¸­é—´ä»¶ (`app/core/rag_middleware.py`)

**èŒè´£**ï¼šåœ¨ Agent æ‰§è¡Œè¿‡ç¨‹ä¸­æ™ºèƒ½é›†æˆ RAG çŸ¥è¯†åº“

**å·¥ä½œæµç¨‹**ï¼š

```
Agent åˆ†æé—®é¢˜
  â†“
Agent ç”Ÿæˆåˆæ­¥å›ç­”ï¼ˆåŒ…å«"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"ï¼‰
  â†“
RAG ä¸­é—´ä»¶æ£€æµ‹åˆ°å…³é”®è¯ï¼ˆafter_model é’©å­ï¼‰
  â†“
æå– Agent çš„åˆ†æç»“æœï¼ˆA-B-C è¿‡ç¨‹ï¼‰
  â†“
ç»“åˆç”¨æˆ·æŸ¥è¯¢å’Œ AI åˆ†æç»“æœè¿›è¡Œ RAG åŒ¹é…
  â†“
ä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³æ ‡å‡†æµç¨‹
  â†“
å°†æ£€ç´¢ç»“æœæ³¨å…¥ä¸Šä¸‹æ–‡
  â†“
Agent å®Œå–„å»ºè®®ï¼Œè¾“å‡ºç¬¦åˆçŸ¥è¯†åº“æ ‡å‡†çš„è¿ç»´å»ºè®®
```

**å…³é”®å®ç°**ï¼š

```python
class RAGMiddleware(AgentMiddleware):
    async def aafter_model(
        self, state: AgentState, runtime: "Runtime"
    ) -> dict[str, Any] | None:
        """åœ¨æ¨¡å‹è°ƒç”¨åæ‰§è¡Œ"""
        messages = state.get("messages", [])
        
        # 1. åˆ¤æ–­æ˜¯å¦éœ€è¦è§¦å‘ RAG
        if not self._should_trigger_rag(messages):
            return None
        
        # 2. æå– Agent çš„åˆ†æç»“æœï¼ˆA-B-C è¿‡ç¨‹ï¼‰
        ai_message = messages[-1]  # æœ€åä¸€æ¡ AI æ¶ˆæ¯
        ai_content = ai_message.content
        
        # 3. æå–"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"éƒ¨åˆ†
        if "å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ" in ai_content:
            query_for_rag = "å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ" + ai_content.split("å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ")[1][:500]
        else:
            query_for_rag = ai_content[:300]
        
        # 4. ç»“åˆç”¨æˆ·æŸ¥è¯¢å’Œ AI åˆ†æç»“æœ
        user_query = self._extract_user_query(messages)
        combined_query = f"{user_query} {query_for_rag}"
        
        # 5. ä» RAG çŸ¥è¯†åº“æ£€ç´¢
        rag_context = await get_rag_context_async(combined_query, k=self.rag_k)
        
        # 6. æ³¨å…¥å¢å¼ºæç¤º
        enhancement_prompt = f"""
è¯·å‚è€ƒä»¥ä¸‹è¿ç»´çŸ¥è¯†åº“ä¸­çš„æ ‡å‡†æµç¨‹å’Œæœ€ä½³å®è·µï¼Œå®Œå–„ä½ çš„"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"éƒ¨åˆ†ï¼š
{rag_context}
"""
        return {"messages": messages + [HumanMessage(content=enhancement_prompt)]}
```

**è§¦å‘æ¡ä»¶**ï¼š

- AI å›ç­”åŒ…å«å…³é”®è¯ï¼š`"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"`, `"å»ºè®®"`, `"æ“ä½œæ­¥éª¤"`, `"æœ€ä½³å®è·µ"` ç­‰
- AI å·²å®Œæˆå·¥å…·è°ƒç”¨ï¼Œå‡†å¤‡è¾“å‡ºæœ€ç»ˆç­”æ¡ˆ

---

### 6. RAG é›†æˆæ¨¡å— (`app/core/rag_integration.py`)

**èŒè´£**ï¼šæä¾› RAG ç³»ç»Ÿçš„ç»Ÿä¸€æ¥å£

**å…³é”®å‡½æ•°**ï¼š

1. `initialize_rag_system()`ï¼šåˆå§‹åŒ– RAG ç³»ç»Ÿ
2. `get_rag_context_async()`ï¼šå¼‚æ­¥æ£€ç´¢çŸ¥è¯†åº“
3. `is_rag_initialized()`ï¼šæ£€æŸ¥ RAG æ˜¯å¦å·²åˆå§‹åŒ–

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# åˆå§‹åŒ– RAG ç³»ç»Ÿ
initialize_rag_system(auto_init=True)

# æ£€ç´¢çŸ¥è¯†åº“
rag_context = await get_rag_context_async(query="Pod é‡å¯é—®é¢˜", k=4)
```

---

## ğŸš€ Agent æ„å»ºæµç¨‹

### å®Œæ•´æ„å»ºæ­¥éª¤

```python
# æ­¥éª¤ 1: åŠ è½½é…ç½®
config = get_config()

# æ­¥éª¤ 2: åˆå§‹åŒ–æ¨¡å‹
model_usage = init_chat_model(
    model=config.get('model.deepseek.model'),
    model_provider=config.get('model.deepseek.model_provider'),
    api_key=config.get('model.deepseek.api'),
    base_url=config.get('model.deepseek.api_base'),
    max_tokens=config.get('model.deepseek.max_token'),
)

# æ­¥éª¤ 3: åŠ è½½å·¥å…·
all_tools = get_all_tools_sync(
    include_kubernetes=True,
    kubernetes_non_destructive=False,
    kubernetes_kubeconfig=None,
    kubernetes_context=None,
)

# æ­¥éª¤ 4: åˆå§‹åŒ– RAG ç³»ç»Ÿ
initialize_rag_system(auto_init=True)

# æ­¥éª¤ 5: åˆ›å»º RAG ä¸­é—´ä»¶
rag_middleware = RAGMiddleware(rag_k=4, enable_auto_rag=True)

# æ­¥éª¤ 6: åˆ›å»º Agent
agent = create_agent(
    model=model_usage,
    tools=all_tools,
    system_prompt=SYSTEM_PROMPT,
    checkpointer=InMemorySaver(),
    middleware=[rag_middleware] if rag_middleware else [],
)
```

### Agent æ‰§è¡Œæµç¨‹

```python
async def run_agent():
    """å¼‚æ­¥è¿è¡Œ Agent"""
    messages = [{"role": "user", "content": question}]
    
    async for token, metadata in agent.astream(
        {'messages': messages},
        {"configurable": {"thread_id": "1"}},
        stream_mode="messages"
    ):
        if hasattr(token, 'content') and token.content:
            print(f"{token.content}", end="", flush=True)
```

---

## ğŸ› ï¸ å·¥å…·ç³»ç»Ÿ

### å·¥å…·ç±»å‹

#### 1. æœ¬åœ°å·¥å…·

**å®šä¹‰æ–¹å¼**ï¼š

```python
from langchain.tools import tool

@tool
def test_output(city: str) -> str:
    """
    è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¾“å‡ºå·¥å…·
    å‚æ•°:
    - city: åŸå¸‚åç§°
    è¿”å›:
    - è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¾“å‡ºå·¥å…·: åŸå¸‚åç§°
    """
    return f"è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¾“å‡ºå·¥å…·123: {city}\n"

tools_usage = [test_output]
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥ï¼ŒPython å‡½æ•°å³å¯
- âœ… åŒæ­¥æ‰§è¡Œï¼Œæ— éœ€å¼‚æ­¥å¤„ç†
- âœ… é€‚åˆç®€å•çš„è®¡ç®—å’ŒæŸ¥è¯¢

#### 2. MCP å·¥å…·

**å®šä¹‰æ–¹å¼**ï¼š

```python
# é€šè¿‡ MultiServerMCPClient è¿æ¥ MCP æœåŠ¡å™¨
client = MultiServerMCPClient({
    "kubernetes": {
        "command": "npx",
        "args": ["-y", "mcp-server-kubernetes"],
        "env": env,
        "transport": "stdio"
    }
})

# è·å–å·¥å…·åˆ—è¡¨
tools = await client.get_tools()
```

**ç‰¹ç‚¹**ï¼š
- âœ… é€šè¿‡ MCP åè®®è¿æ¥å¤–éƒ¨æœåŠ¡
- âœ… å·¥å…·ç”± MCP æœåŠ¡å™¨æä¾›ï¼Œæ— éœ€æ‰‹åŠ¨å®šä¹‰
- âœ… æ”¯æŒå¼‚æ­¥è°ƒç”¨
- âœ… å¯æ‰©å±•ï¼šæ”¯æŒå¤šä¸ª MCP æœåŠ¡å™¨

### å·¥å…·é€‰æ‹©æœºåˆ¶

**LLM å¦‚ä½•é€‰æ‹©å·¥å…·**ï¼š

1. **åŸºäºå·¥å…·æè¿°**ï¼šLLM æ ¹æ®å·¥å…·çš„ `name` å’Œ `description` é€‰æ‹©
2. **è¯­ä¹‰åŒ¹é…**ï¼šLLM ç†è§£ç”¨æˆ·æ„å›¾ï¼ŒåŒ¹é…æœ€åˆé€‚çš„å·¥å…·
3. **å·¥å…·è°ƒç”¨**ï¼šLLM ç”Ÿæˆå·¥å…·è°ƒç”¨è¯·æ±‚ï¼ŒåŒ…å«å·¥å…·åå’Œå‚æ•°

**å…³é”®ä»£ç ä½ç½®**ï¼š

- å·¥å…·å®šä¹‰ï¼š`app/tools/base.py`ï¼ˆæœ¬åœ°å·¥å…·ï¼‰
- å·¥å…·è·å–ï¼š`app/tools/mcp_tools.py`ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
- å·¥å…·è°ƒç”¨ï¼šç”± LangChain `create_agent` è‡ªåŠ¨å¤„ç†

---

## ğŸ“š RAG çŸ¥è¯†åº“ç³»ç»Ÿ

### ç³»ç»Ÿæ¶æ„

```
app/rag/
â”œâ”€â”€ document_loader.py      # æ–‡æ¡£åŠ è½½å™¨
â”œâ”€â”€ pdf_utils.py           # PDF å¤„ç†å·¥å…·
â”œâ”€â”€ vector_store.py        # å‘é‡å­˜å‚¨ç®¡ç†å™¨
â”œâ”€â”€ zhipu_embeddings.py    # æ™ºè°±AI Embedding å®ç°
â”œâ”€â”€ rag_retriever.py       # RAG æ£€ç´¢å™¨
â””â”€â”€ files/                 # çŸ¥è¯†åº“æ–‡ä»¶ç›®å½•
    â”œâ”€â”€ *.txt              # TXT æ–‡æ¡£
    â””â”€â”€ *.pdf              # PDF æ–‡æ¡£
```

### æ ¸å¿ƒç»„ä»¶

#### 1. æ–‡æ¡£åŠ è½½å™¨ (`document_loader.py`)

**åŠŸèƒ½**ï¼š
- ä» `app/rag/files/` ç›®å½•åŠ è½½ `.txt` å’Œ `.pdf` æ–‡ä»¶
- ä½¿ç”¨ `RecursiveCharacterTextSplitter` åˆ†å‰²æ–‡æœ¬
- åˆ›å»º `Document` å¯¹è±¡ï¼ŒåŒ…å«å…ƒæ•°æ®ï¼ˆæ–‡ä»¶åã€æ–‡ä»¶ç±»å‹ã€å—ç´¢å¼•ï¼‰

**å…³é”®ä»£ç **ï¼š

```python
class DocumentLoader:
    def load_all_documents(self) -> List[Document]:
        """åŠ è½½æ‰€æœ‰æ–‡æ¡£"""
        all_documents = []
        
        for file_path in self.files_dir.iterdir():
            if file_path.suffix.lower() == '.txt':
                docs = self.load_txt_file(file_path)
                all_documents.extend(docs)
            elif file_path.suffix.lower() == '.pdf':
                docs = self.load_pdf_file(file_path)
                all_documents.extend(docs)
        
        return all_documents
```

#### 2. å‘é‡å­˜å‚¨ç®¡ç†å™¨ (`vector_store.py`)

**åŠŸèƒ½**ï¼š
- ç®¡ç† Embedding æ¨¡å‹çš„åˆå§‹åŒ–ï¼ˆæ”¯æŒ DeepSeek å’Œæ™ºè°±AIï¼‰
- ä½¿ç”¨ `InMemoryVectorStore` å­˜å‚¨å‘é‡
- æä¾›è¯­ä¹‰æœç´¢åŠŸèƒ½

**å…³é”®ç‰¹æ€§**ï¼š

1. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šEmbedding æ¨¡å‹åœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–ï¼Œé¿å…å¯åŠ¨æ—¶ç½‘ç»œé—®é¢˜
2. **æ‰¹é‡å¤„ç†**ï¼šæ–‡æ¡£å‘é‡åŒ–é‡‡ç”¨æ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡
3. **é‡è¯•æœºåˆ¶**ï¼šåˆå§‹åŒ–å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡
4. **æ™ºè°±AI æ”¯æŒ**ï¼šé’ˆå¯¹æ™ºè°±AI çš„é€Ÿç‡é™åˆ¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰ `ZhipuAIEmbeddings`

**å…³é”®ä»£ç **ï¼š

```python
class VectorStoreManager:
    def initialize(self, documents: List[Document], batch_size: int = 10):
        """åˆå§‹åŒ–å‘é‡å­˜å‚¨å¹¶æ·»åŠ æ–‡æ¡£"""
        # 1. åˆå§‹åŒ– Embedding æ¨¡å‹
        embeddings = self._init_embeddings()
        
        # 2. åˆ›å»ºå‘é‡å­˜å‚¨
        self.vector_store = InMemoryVectorStore(embedding=embeddings)
        
        # 3. æ‰¹é‡æ·»åŠ æ–‡æ¡£
        for i in range(0, len(documents), batch_size):
            batch = documents[i:i + batch_size]
            self.vector_store.add_documents(batch)
```

#### 3. æ™ºè°±AI Embedding (`zhipu_embeddings.py`)

**åŠŸèƒ½**ï¼š
- å®ç° LangChain `Embeddings` æ¥å£
- è°ƒç”¨æ™ºè°±AI `embedding-2` æˆ– `embedding-3` æ¨¡å‹
- å¤„ç†é€Ÿç‡é™åˆ¶ï¼ˆHTTP 429ï¼‰ï¼Œå®ç°æŒ‡æ•°é€€é¿é‡è¯•

**å…³é”®ç‰¹æ€§**ï¼š

1. **é€Ÿç‡é™åˆ¶å¤„ç†**ï¼š
   - æ£€æµ‹ `Retry-After` å“åº”å¤´
   - æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæœ€å¤š 5 æ¬¡ï¼Œæœ€é•¿ç­‰å¾… 120 ç§’ï¼‰
   - å¯é…ç½®æ‰¹é‡å¤§å°å’Œè¯·æ±‚å»¶è¿Ÿ

2. **æ‰¹é‡å¤„ç†**ï¼š
   - é»˜è®¤æ‰¹é‡å¤§å°ï¼š1ï¼ˆæœ€ä¿å®ˆï¼Œé¿å…é€Ÿç‡é™åˆ¶ï¼‰
   - é»˜è®¤è¯·æ±‚å»¶è¿Ÿï¼š5 ç§’

**å…³é”®ä»£ç **ï¼š

```python
class ZhipuAIEmbeddings(Embeddings):
    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        """æ‰¹é‡åµŒå…¥æ–‡æ¡£"""
        results = []
        
        for i in range(0, len(texts), self.batch_size):
            batch = texts[i:i + self.batch_size]
            
            # å¤„ç†é€Ÿç‡é™åˆ¶
            for attempt in range(self.max_retries):
                try:
                    response = self.client.embeddings.create(
                        model=self.model,
                        input=batch
                    )
                    results.extend([item.embedding for item in response.data])
                    break
                except Exception as e:
                    if "429" in str(e):
                        # å¤„ç†é€Ÿç‡é™åˆ¶
                        wait_time = self._calculate_wait_time(attempt)
                        time.sleep(wait_time)
                    else:
                        raise
```

#### 4. RAG æ£€ç´¢å™¨ (`rag_retriever.py`)

**åŠŸèƒ½**ï¼š
- ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ£€ç´¢
- æ ¼å¼åŒ–æ£€ç´¢ç»“æœ

**å…³é”®ä»£ç **ï¼š

```python
class RAGRetriever:
    async def aretrieve(self, query: str) -> List[Document]:
        """å¼‚æ­¥æ£€ç´¢ç›¸å…³æ–‡æ¡£"""
        documents = await self.vector_store_manager.asearch(query, k=self.k)
        return documents
```

### RAG å·¥ä½œæµç¨‹

```
1. åˆå§‹åŒ–é˜¶æ®µ
   â”œâ”€â”€ åŠ è½½æ–‡æ¡£ï¼ˆTXT/PDFï¼‰
   â”œâ”€â”€ æ–‡æœ¬åˆ†å‰²ï¼ˆchunk_size=1000, chunk_overlap=200ï¼‰
   â”œâ”€â”€ å‘é‡åŒ–ï¼ˆä½¿ç”¨ Embedding æ¨¡å‹ï¼‰
   â””â”€â”€ å­˜å‚¨åˆ° InMemoryVectorStore

2. æ£€ç´¢é˜¶æ®µ
   â”œâ”€â”€ ç”¨æˆ·æŸ¥è¯¢æˆ– Agent åˆ†æç»“æœ
   â”œâ”€â”€ å‘é‡åŒ–æŸ¥è¯¢æ–‡æœ¬
   â”œâ”€â”€ è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ï¼ˆCosine Similarityï¼‰
   â””â”€â”€ è¿”å› Top-K ç›¸å…³æ–‡æ¡£

3. å¢å¼ºé˜¶æ®µ
   â”œâ”€â”€ æ ¼å¼åŒ–æ£€ç´¢ç»“æœ
   â”œâ”€â”€ æ³¨å…¥åˆ° Agent ä¸Šä¸‹æ–‡
   â””â”€â”€ Agent åŸºäºçŸ¥è¯†åº“å®Œå–„å›ç­”
```

### å­˜å‚¨æœºåˆ¶

**é—®é¢˜**ï¼šEmbedding åæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿæ¯æ¬¡è¿è¡Œéƒ½è¦é‡æ–° Embedding å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼š
- âœ… **å­˜å‚¨ä½ç½®**ï¼š`InMemoryVectorStore`ï¼Œæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­
- âŒ **æŒä¹…åŒ–**ï¼šå½“å‰å®ç°ä¸æ”¯æŒæŒä¹…åŒ–ï¼Œæ¯æ¬¡è¿è¡Œéƒ½éœ€è¦é‡æ–° Embedding
- ğŸ’¡ **ä¼˜åŒ–å»ºè®®**ï¼šå¯ä»¥æ”¹ç”¨ `Chroma` æˆ– `FAISS` ç­‰æ”¯æŒæŒä¹…åŒ–çš„å‘é‡æ•°æ®åº“

### åŒ¹é…æœºåˆ¶

**é—®é¢˜**ï¼šRAG åŒ¹é…æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿé»˜è®¤æ˜¯è¯­ä¹‰åŒ¹é…å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼š
- âœ… **åŒ¹é…æ–¹å¼**ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ï¼ˆCosine Similarityï¼‰
- âœ… **åŒ¹é…è¿‡ç¨‹**ï¼š
  1. å°†æŸ¥è¯¢æ–‡æœ¬å‘é‡åŒ–
  2. è®¡ç®—æŸ¥è¯¢å‘é‡ä¸æ‰€æœ‰æ–‡æ¡£å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
  3. è¿”å› Top-K æœ€ç›¸ä¼¼çš„æ–‡æ¡£
- âœ… **åŒ¹é…æ—¶æœº**ï¼šåœ¨ Agent å‡†å¤‡è¾“å‡º"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"æ—¶è§¦å‘ï¼ˆ`after_model` é’©å­ï¼‰

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·æé—®                                                  â”‚
â”‚     "æˆ‘çš„ Pod ä¸€ç›´é‡å¯ï¼Œæ€ä¹ˆåŠï¼Ÿ"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Agent åˆ†æé—®é¢˜                                            â”‚
â”‚     - ç†è§£ç”¨æˆ·æ„å›¾                                            â”‚
â”‚     - æå–å…³é”®å®ä½“ï¼ˆPod åã€å‘½åç©ºé—´ç­‰ï¼‰                       â”‚
â”‚     - å½¢æˆåˆæ­¥å‡è®¾                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Agent é€‰æ‹©å¹¶è°ƒç”¨å·¥å…·                                       â”‚
â”‚     - kubectl get pods                                       â”‚
â”‚     - kubectl describe pod                                   â”‚
â”‚     - kubectl logs                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Agent ç”Ÿæˆåˆæ­¥å›ç­”                                        â”‚
â”‚     "å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆï¼š                                            â”‚
â”‚      1. æ£€æŸ¥ Pod çŠ¶æ€                                        â”‚
â”‚      2. æŸ¥çœ‹æ—¥å¿—                                             â”‚
â”‚      3. éªŒè¯é…ç½®"                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. RAG ä¸­é—´ä»¶æ£€æµ‹åˆ°"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"å…³é”®è¯                        â”‚
â”‚     - è§¦å‘ RAG æ£€ç´¢                                          â”‚
â”‚     - æå– Agent åˆ†æç»“æœï¼ˆA-B-C è¿‡ç¨‹ï¼‰                        â”‚
â”‚     - ç»„åˆæŸ¥è¯¢ï¼š"Pod é‡å¯ å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆï¼š1. æ£€æŸ¥..."            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. RAG æ£€ç´¢çŸ¥è¯†åº“                                            â”‚
â”‚     - å‘é‡åŒ–æŸ¥è¯¢æ–‡æœ¬                                          â”‚
â”‚     - è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢                                          â”‚
â”‚     - è¿”å› Top-K ç›¸å…³æ–‡æ¡£                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. æ³¨å…¥ RAG ä¸Šä¸‹æ–‡                                           â”‚
â”‚     "è¯·å‚è€ƒä»¥ä¸‹è¿ç»´çŸ¥è¯†åº“ä¸­çš„æ ‡å‡†æµç¨‹..."                      â”‚
â”‚     [å‚è€ƒæ–‡æ¡£ 1: Pod é‡å¯æ’æŸ¥æ‰‹å†Œ]                            â”‚
â”‚     [å‚è€ƒæ–‡æ¡£ 2: Kubernetes æ•…éšœå¤„ç†æœ€ä½³å®è·µ]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Agent å®Œå–„å»ºè®®                                            â”‚
â”‚     "å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆï¼ˆåŸºäºçŸ¥è¯†åº“æ ‡å‡†æµç¨‹ï¼‰ï¼š                        â”‚
â”‚      1. æ£€æŸ¥ Pod çŠ¶æ€ï¼ˆæ ‡å‡†æ­¥éª¤ï¼‰                             â”‚
â”‚      2. æŸ¥çœ‹æ—¥å¿—ï¼ˆæ ‡å‡†æ­¥éª¤ï¼‰                                 â”‚
â”‚      3. éªŒè¯é…ç½®ï¼ˆæ ‡å‡†æ­¥éª¤ï¼‰"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å†³ç­–ç‚¹

1. **å·¥å…·é€‰æ‹©**ï¼šLLM æ ¹æ®å·¥å…·æè¿°è‡ªåŠ¨é€‰æ‹©
2. **RAG è§¦å‘**ï¼šæ£€æµ‹åˆ°"å»ºè®®è¡ŒåŠ¨æ–¹æ¡ˆ"ç­‰å…³é”®è¯æ—¶è§¦å‘
3. **åŒ¹é…ç­–ç•¥**ï¼šä½¿ç”¨ Agent åˆ†æç»“æœ + ç”¨æˆ·æŸ¥è¯¢è¿›è¡ŒåŒ¹é…

---

## ğŸ”‘ å…³é”®æŠ€æœ¯å®ç°

### 1. å¼‚æ­¥å·¥å…·è°ƒç”¨

**é—®é¢˜**ï¼šMCP å·¥å…·æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ä½•ä¸åŒæ­¥ Agent é›†æˆï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# ä½¿ç”¨ agent.astream è€Œä¸æ˜¯ agent.stream
async for token, metadata in agent.astream(
    {'messages': messages},
    {"configurable": {"thread_id": "1"}},
    stream_mode="messages"
):
    # å¤„ç†æµå¼è¾“å‡º
    if hasattr(token, 'content') and token.content:
        print(f"{token.content}", end="", flush=True)

# ä½¿ç”¨ asyncio.run è¿è¡Œå¼‚æ­¥å‡½æ•°
if __name__ == "__main__":
    asyncio.run(run_agent())
```

### 2. ä¸­é—´ä»¶æœºåˆ¶

**LangChain ä¸­é—´ä»¶é’©å­**ï¼š

- `before_agent`ï¼šAgent å¯åŠ¨å‰
- `before_model`ï¼šæ¨¡å‹è°ƒç”¨å‰
- `after_model`ï¼šæ¨¡å‹å“åº”åï¼ˆ**RAG ä¸­é—´ä»¶ä½¿ç”¨æ­¤é’©å­**ï¼‰
- `after_agent`ï¼šAgent å®Œæˆæ—¶

**å®ç°æ–¹å¼**ï¼š

```python
class RAGMiddleware(AgentMiddleware):
    async def aafter_model(
        self, state: AgentState, runtime: "Runtime"
    ) -> dict[str, Any] | None:
        """åœ¨æ¨¡å‹è°ƒç”¨åæ‰§è¡Œ"""
        # æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘ RAG
        if self._should_trigger_rag(messages):
            # æ£€ç´¢çŸ¥è¯†åº“
            rag_context = await get_rag_context_async(query, k=self.rag_k)
            # æ³¨å…¥ä¸Šä¸‹æ–‡
            return {"messages": messages + [HumanMessage(content=enhancement_prompt)]}
        return None
```

### 3. å¤šé›†ç¾¤æ”¯æŒ

**é…ç½®æ–¹å¼**ï¼š

```yaml
# config/config.yaml
model:
  mcp:
    kubernetes:
      non_destructive: false
      kubeconfig: "/path/to/kubeconfig"  # å¯é€‰
      context: "production-cluster"       # å¯é€‰
```

**å®ç°æ–¹å¼**ï¼š

```python
# é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’é…ç½®
env = {}
if kubeconfig:
    env["KUBECONFIG"] = kubeconfig
if context:
    env["KUBECTL_CONTEXT"] = context

client = MultiServerMCPClient({
    "kubernetes": {
        "command": "npx",
        "args": ["-y", "mcp-server-kubernetes"],
        "env": env,
        "transport": "stdio"
    }
})
```

### 4. é€Ÿç‡é™åˆ¶å¤„ç†

**æ™ºè°±AI Embedding é€Ÿç‡é™åˆ¶å¤„ç†**ï¼š

```python
class ZhipuAIEmbeddings(Embeddings):
    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        for attempt in range(self.max_retries):
            try:
                response = self.client.embeddings.create(...)
                return results
            except Exception as e:
                if "429" in str(e):
                    # è§£æ Retry-After å¤´
                    wait_time = self._parse_retry_after(e)
                    # æŒ‡æ•°é€€é¿
                    wait_time = min(wait_time * (2 ** attempt), 120)
                    time.sleep(wait_time)
                else:
                    raise
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶ç»“æ„ (`config/config.yaml`)

```yaml
model:
  deepseek:
    api: "sk-xxx"
    model_provider: 'openai'
    model: 'deepseek-chat'
    api_base: 'https://api.deepseek.com'
    max_token: 2048
  glm:
    api: "xxx"
  rag:
    embedding_model: 'embedding-2'  # æ™ºè°±AI embedding æ¨¡å‹
  mcp:
    kubernetes:
      non_destructive: false
      kubeconfig: null
      context: null
```

### é…ç½®åŠ è½½ (`config/config_loader.py`)

```python
def get_config():
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    config_path = Path(__file__).parent / "config.yaml"
    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
    return config
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
matain_agent/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ agent.py            # Agent ä¸»æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ prompt.py           # ç³»ç»Ÿæç¤ºè¯
â”‚   â”‚   â”œâ”€â”€ rag_integration.py  # RAG é›†æˆæ¥å£
â”‚   â”‚   â”œâ”€â”€ rag_middleware.py   # RAG ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ mcp_servers/        # MCP æœåŠ¡å™¨é›†æˆ
â”‚   â”‚       â””â”€â”€ kubernetes_mcp.py
â”‚   â”œâ”€â”€ rag/                     # RAG ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ document_loader.py  # æ–‡æ¡£åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ pdf_utils.py        # PDF å¤„ç†
â”‚   â”‚   â”œâ”€â”€ vector_store.py     # å‘é‡å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ zhipu_embeddings.py # æ™ºè°±AI Embedding
â”‚   â”‚   â”œâ”€â”€ rag_retriever.py    # RAG æ£€ç´¢å™¨
â”‚   â”‚   â””â”€â”€ files/              # çŸ¥è¯†åº“æ–‡ä»¶
â”‚   â”œâ”€â”€ tools/                   # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ base.py             # æœ¬åœ°å·¥å…·
â”‚   â”‚   â””â”€â”€ mcp_tools.py        # MCP å·¥å…·é›†æˆ
â”‚   â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”œâ”€â”€ config/                      # é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ config.yaml             # ä¸»é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config_loader.py        # é…ç½®åŠ è½½å™¨
â”œâ”€â”€ docs/                         # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ RAG_INTEGRATION_GUIDE.md
â”‚   â”œâ”€â”€ RAG_MIDDLEWARE_GUIDE.md
â”‚   â”œâ”€â”€ MCP_WORKFLOW_AND_CONFIG.md
â”‚   â””â”€â”€ ...
â”œâ”€â”€ requirements.txt             # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ setup.py                     # åŒ…å®‰è£…é…ç½®
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ä¸­é—´ä»¶è€Œä¸æ˜¯ç›´æ¥æ³¨å…¥ RAGï¼Ÿ

**åŸå› **ï¼š
- âœ… **æ—¶æœºæ§åˆ¶**ï¼šåªåœ¨ Agent å‡†å¤‡è¾“å‡ºå»ºè®®æ—¶è§¦å‘ï¼Œé¿å…è¿‡æ—©æ£€ç´¢
- âœ… **ç²¾å‡†åŒ¹é…**ï¼šä½¿ç”¨ Agent çš„åˆ†æç»“æœï¼ˆA-B-C è¿‡ç¨‹ï¼‰è¿›è¡ŒåŒ¹é…ï¼Œæ›´å‡†ç¡®
- âœ… **æµç¨‹æ¸…æ™°**ï¼šAgent å…ˆåˆ†æï¼Œå†æ£€ç´¢ï¼Œæœ€åå®Œå–„ï¼Œæµç¨‹æ¸…æ™°

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ InMemoryVectorStoreï¼Ÿ

**åŸå› **ï¼š
- âœ… **ç®€å•å¿«é€Ÿ**ï¼šæ— éœ€é¢å¤–ä¾èµ–ï¼Œå¯åŠ¨å¿«
- âœ… **é€‚åˆå¼€å‘**ï¼šå¼€å‘é˜¶æ®µæ•°æ®é‡å°ï¼Œå†…å­˜å­˜å‚¨è¶³å¤Ÿ
- âš ï¸ **ç”Ÿäº§å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ `Chroma` æˆ– `FAISS` æ”¯æŒæŒä¹…åŒ–

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨æ™ºè°±AI Embeddingï¼Ÿ

**åŸå› **ï¼š
- âœ… **æˆæœ¬è€ƒè™‘**ï¼šæ™ºè°±AI æä¾›å…è´¹çš„ Embedding æœåŠ¡
- âœ… **ä¸­æ–‡æ”¯æŒ**ï¼šå¯¹ä¸­æ–‡è¯­ä¹‰ç†è§£æ›´å¥½
- âš ï¸ **é€Ÿç‡é™åˆ¶**ï¼šéœ€è¦å¤„ç†é€Ÿç‡é™åˆ¶ï¼Œå·²å®ç°é‡è¯•æœºåˆ¶

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. RAG åˆå§‹åŒ–ä¼˜åŒ–

- âœ… **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šEmbedding æ¨¡å‹åœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–
- âœ… **æ‰¹é‡å¤„ç†**ï¼šæ–‡æ¡£å‘é‡åŒ–é‡‡ç”¨æ‰¹é‡å¤„ç†
- âœ… **é‡è¯•æœºåˆ¶**ï¼šåˆå§‹åŒ–å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

### 2. å·¥å…·è°ƒç”¨ä¼˜åŒ–

- âœ… **å¼‚æ­¥æ‰§è¡Œ**ï¼šæ‰€æœ‰å·¥å…·è°ƒç”¨é‡‡ç”¨å¼‚æ­¥æ–¹å¼
- âœ… **æµå¼è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤º AI å›ç­”ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 3. é€Ÿç‡é™åˆ¶å¤„ç†

- âœ… **æŒ‡æ•°é€€é¿**ï¼šæ™ºè°±AI Embedding é€Ÿç‡é™åˆ¶æ—¶è‡ªåŠ¨é‡è¯•
- âœ… **æ‰¹é‡æ§åˆ¶**ï¼šå¯é…ç½®æ‰¹é‡å¤§å°å’Œè¯·æ±‚å»¶è¿Ÿ

---

## ğŸ”® æœªæ¥æ‰©å±•æ–¹å‘

### 1. æ”¯æŒæ›´å¤š MCP æœåŠ¡å™¨

- Prometheus MCP
- Elasticsearch MCP
- Deepflow MCP

### 2. RAG ç³»ç»Ÿä¼˜åŒ–

- æ”¯æŒæŒä¹…åŒ–å‘é‡å­˜å‚¨ï¼ˆChroma / FAISSï¼‰
- æ”¯æŒå¢é‡æ›´æ–°çŸ¥è¯†åº“
- æ”¯æŒå¤šæ¨¡æ€æ–‡æ¡£ï¼ˆå›¾ç‰‡ã€è¡¨æ ¼ï¼‰

### 3. Agent èƒ½åŠ›å¢å¼º

- æ”¯æŒå¤šè½®å¯¹è¯è®°å¿†
- æ”¯æŒå·¥å…·é“¾è°ƒç”¨
- æ”¯æŒè‡ªå®šä¹‰å·¥å…·

---

## ğŸ“ æ€»ç»“

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ª**å®Œæ•´çš„æ™ºèƒ½è¿ç»´ Agent ç³»ç»Ÿ**ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

1. **æ™ºèƒ½åˆ†æ**ï¼šåŸºäº LangChain å’Œ LangGraph æ„å»ºçš„ Agentï¼Œèƒ½å¤Ÿç†è§£ç”¨æˆ·æ„å›¾å¹¶é€‰æ‹©åˆé€‚å·¥å…·
2. **å·¥å…·é›†æˆ**ï¼šæ”¯æŒæœ¬åœ°å·¥å…·å’Œ MCP å·¥å…·ï¼Œå¯æ‰©å±•æ€§å¼º
3. **çŸ¥è¯†å¢å¼º**ï¼šé€šè¿‡ RAG ä¸­é—´ä»¶åœ¨å…³é”®æ—¶åˆ»æ³¨å…¥ä¸“ä¸šçŸ¥è¯†ï¼Œæå‡å›ç­”è´¨é‡
4. **å¤šé›†ç¾¤æ”¯æŒ**ï¼šæ”¯æŒ Kubernetes å¤šé›†ç¾¤é…ç½®
5. **å¼‚æ­¥ä¼˜å…ˆ**ï¼šæ‰€æœ‰ I/O æ“ä½œé‡‡ç”¨å¼‚æ­¥å¤„ç†ï¼Œæ€§èƒ½ä¼˜å¼‚

**å…³é”®æŠ€æœ¯æ ˆ**ï¼š
- LangChain / LangGraphï¼šAgent æ¡†æ¶
- MCP (Model Context Protocol)ï¼šå·¥å…·åè®®
- RAG (Retrieval-Augmented Generation)ï¼šçŸ¥è¯†å¢å¼º
- æ™ºè°±AI / DeepSeekï¼šå¤§è¯­è¨€æ¨¡å‹å’Œ Embedding æ¨¡å‹

**é¡¹ç›®äº®ç‚¹**ï¼š
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- âœ… ä¸­é—´ä»¶æœºåˆ¶ï¼Œçµæ´»æ§åˆ¶æµç¨‹
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œä»£ç æ³¨é‡Š

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-XX  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

